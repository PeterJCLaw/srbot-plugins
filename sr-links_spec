#!/usr/bin/env rspec

require './test_mocks.rb'

require './sr-links.rb'

describe SRLinksPlugin, "#listen" do

  ["#", "t:#"].each do |prefix|
    [
    "#{prefix}123",
    "things #{prefix}123",
    "#{prefix}123 here",
    "things #{prefix}123 here",
    ].each do |text|
      it "should find trac number 123 when listening to '#{text}'." do
        msg = TestableMessage.new
        msg.message = text
        plugin = SRLinksPlugin.new
        plugin.listen(msg)
        msg.get_replies.should eq("http://trac.srobo.org/ticket/123\n")
      end
    end
  end

  [
  "t:Competition",
  "things t:Competition",
  "t:Competition here",
  "things t:Competition here",
  ].each do |text|
    it "should find trac page Competition when listening to '#{text}'." do
      msg = TestableMessage.new
      msg.message = text
      plugin = SRLinksPlugin.new
      plugin.listen(msg)
      msg.get_replies.should eq("http://trac.srobo.org/wiki/Competition\n")
    end
  end

  [
  "t:ThisPageMustNotExist",
  "things t:ThisPageMustNotExist",
  "t:ThisPageMustNotExist here",
  "things t:ThisPageMustNotExist here",
  ].each do |text|
    it "should not reply with trac page ThisPageMustNotExist when listening to '#{text}'." do
      msg = TestableMessage.new
      msg.message = text
      plugin = SRLinksPlugin.new
      plugin.listen(msg)
      msg.get_replies.should eq("")
    end
  end

  [
  "123",
  "things not 123 here",
  "things not #0147here either",
  "things not #here either",
  "#here",
  "#1000000000000",
  ].each do |text|
    it "shouldn't find a trac number when listening to '#{text}'." do
      msg = TestableMessage.new
      msg.message = text
      plugin = SRLinksPlugin.new
      plugin.listen(msg)
      msg.get_replies.should eq("")
    end
  end

  [
  "trac 123",
  "trac #123",
  "trac things #123",
  "trac #123 here",
  "trac things #123 here",
  ].each do |text|
    it "should find trac number 123 when directly messaged '#{text}'." do
      msg = TestableMessage.new
      msg.message = text
      plugin = SRLinksPlugin.new
      plugin.privmsg(msg)
      msg.get_replies.should eq("http://trac.srobo.org/ticket/123\n")
    end
  end

  Hash[
  "trac PageName" => "PageName",
  "trac Spacey Page Name" => "Spacey%20Page%20Name",
  ].each {|text, page|
    it "should link a trac page when directly messaged '#{text}'." do
      msg = TestableMessage.new
      msg.message = text
      plugin = SRLinksPlugin.new
      plugin.privmsg(msg)
      msg.get_replies.should eq("http://trac.srobo.org/wiki/#{page}\n")
    end
  }

  ## Gerrit related things ##

  ["gerrit:", "g:"].each do |prefix|
    [
    "#{prefix}123",
    "things #{prefix}123",
    "#{prefix}123 here",
    "things #{prefix}123 here",
    "punctuation1: #{prefix}123: here",
    "punctuation2. #{prefix}123. here",
    "punctuation3, #{prefix}123, here",
    "punctuation4? #{prefix}123? here",
    ].each do |text|
      it "should find gerrit number 123 when listening to '#{text}'." do
        msg = TestableMessage.new
        msg.message = text
        plugin = SRLinksPlugin.new
        plugin.listen(msg)
        msg.get_replies.should eq("http://gerrit.srobo.org/123\n")
      end
    end
  end

  ["gerrit:", "g:"].each do |prefix|
    [
    "123",
    "things not 123 here",
    "things not #{prefix}0147here either",
    "things not #{prefix}here either",
    ].each do |text|
      it "should not find a gerrit number when listening to '#{text}'." do
        msg = TestableMessage.new
        msg.message = text
        plugin = SRLinksPlugin.new
        plugin.listen(msg)
        msg.get_replies.should eq("")
      end
    end
  end

  ## CGit related things ##

  ["cgit:", "git:"].each do |prefix|
    ["repo-name", "repo/name"].each do |name|
      [
      "#{prefix}#{name}",
      "things #{prefix}#{name}",
      "#{prefix}#{name} here",
      "things #{prefix}#{name} here",
      "#{prefix}#{name}.git",
      "things #{prefix}#{name}.git",
      "#{prefix}#{name}.git here",
      "things #{prefix}#{name}.git here",
      ].each do |text|
        it "should find git repo '#{name}' when listening to '#{text}'." do
          msg = TestableMessage.new
          msg.message = text
          plugin = SRLinksPlugin.new
          plugin.listen(msg)
          msg.get_replies.should eq("http://srobo.org/cgit/#{name}.git\n")
        end
      end
    end
  end

  [
  "repo-name.git",
  "nope git:// things",
  "things not repo-name.git here",
  ].each do |text|
    it "should not find a git repo when listening to '#{text}'." do
      msg = TestableMessage.new
      msg.message = text
      plugin = SRLinksPlugin.new
      plugin.listen(msg)
      msg.get_replies.should eq("")
    end
  end
end
